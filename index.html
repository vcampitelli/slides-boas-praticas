<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="author" content="Vinícius Campitelli">

        <title>Boas práticas na prática</title>

        <link rel="stylesheet" href="reveal.js/css/reveal.css">
        <link rel="stylesheet" href="reveal.js/css/theme/sky.css">
        <link rel="stylesheet" href="css/prism.css">
        <link rel="stylesheet" href="css/app.css">

        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'reveal.js/' + window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>Boas práticas</h1>
                    <h2 class="fragment">na prática</h2>
                </section>
                <section>
                    <h2>Quem sou eu?</h2>
                    <ul>
                        <li>Vinícius Campitelli &bull; <a href="http://vcampitelli.github.io">vcampitelli.github.io</a></li>
                        <li>MT4 Tecnologia &bull; @MediaPost &bull; Curseduca</li>
                    </ul>
                </section>
                <section>
                    <h2>Agenda</h2>
                    <ul>
                        <li>SOLID</li>
                        <li>Object Calisthenics</li>
                        <li>PHPCS</li>
                        <li>PHPMD</li>
                    </ul>
                </section>

                <section>
                    <section>
                        <h2>SOLID</h2>
                    </section>

                    <!-- SOLID: SRP -->
                    <section>
                        <h3>Single Responsibility Principle</h3>
                        <p class="fragment">uma classe só pode ter uma única responsabilidade</p>
                    </section>
                    <section>

                        <pre><code class="language-php">class Report {
    public function __construct(Pdo $dbh) { /* ... */ }

    public function fetch() { /* ... */ }

    public function asHtml() { /* ... */ }

    public function asJson() { /* ... */ }
}</code></pre>
                    </section>
                    <section>
                        <h4>Como resolver?</h4>
                        <p class="fragment">Especialize suas classes dividindo-as até que tenham somente um objetivo</p>
                    </section>
                    <section>
                        <pre><code class="language-php">class Report {
    public function __construct(Pdo $dbh) { /* ... */ }
    public function fetch() { /* ... */ }
}

class HtmlReportWriter {
    public function export(Report $report) { /* ... */ }
}

class JsonReportWriter {
    public function export(Report $report) { /* ... */ }
}</code></pre>
                    </section>

                    <!-- SOLID: Open Closed -->
                    <section>
                        <h3>Open Closed Principle</h3>
                        <p class="fragment">entidades devem ser abertas para extensão mas fechadas para modificação</p>
                    </section>
                    <section>
                        <p>É possível implementar uma nova funcionalidade em seu sistema somente adicionando novas classes ao invés de modificá-las?</p>
                    </section>
                    <section>
                        <pre><code class="language-php">class ReportExporter {
    public function toCsv(Report $report) {
        $tempFile = $this->createNewFile();
        $handler = fopen($tempFile, 'w');
        foreach ($report as $row) {
            fputcsv($handler, $row);
        }
        fclose($handler);
        return $tempFile;
    }
}</code></pre>
                    </section>
                    <section>
                        Como adicionar um método que exporta como PDF?
                    </section>
                    <section>
                        <pre><code class="language-php">class ReportExporter {
    public function toCsv(Report $report) { /* ... */ }

    public function toPdf(Report $report) { /* ... */ }
}</code></pre>
                    </section>
                    <section>
                        <h4>Como resolver?</h4>
                        <p class="fragment">Crie estruturas polimórficas.</p>
                        <p class="fragment">Em PHP, utilize interfaces!</p>
                    </section>
                    <section>
                        <pre><code class="language-php">class ReportExporter {
    public function export(Report $report, WriterInterface $writer) {
        $tempFile = $this->createNewFile();
        $writer->setFile($tempFile);
        foreach ($report as $row) {
            $writer->write($row);
        }
        $writer->finish();
        return $tempFile;
    }
}</code></pre>
                    </section>

                    <!-- SOLID: Liskov Substitution -->
                    <section>
                        <h3>Liskov Substitution Principle</h3>
                        <p class="fragment">objetos em um programa deveriam ser substituíveis por instâncias de seus subtipos sem alterar a exatidão do programa</p>
                    </section>
                    <section>
                        <p>Meu sistema precisa funcionar corretamente ao trocar o tipo do <code>Writer</code></p>
                        <pre><code class="language-php">$writer = new CsvWriter();
$writer->write(/* ... */);

$writer = new FileWriter();
$writer->write(/* ... */);
</code></pre>
                    </section>
                    <section>
                        <p>Pré-condições não podem ser fortalecidas em uma subclasse</p>
                        <pre><code class="language-php">class DatabaseAdapter {
    public function query(Statement $statement) { /* ... */ }
}

class PdoStatement extends Statement {
    /* ... */
}

class PdoDatabaseAdapter extends DatabaseAdapter {
    // Errado!
    public function query(PdoStatement $statement) { /* ... */ }
}
</code></pre>
                    </section>
                    <section>
                        <p>Pós-condições não podem ser enfraquecidas em uma subclasse</p>
                        <pre><code class="language-php">class Database {
    public function disconnect() { /* ... */ }
}

class PersistentDatabase extends Database {
    public function disconnect() {
        // um método sobrescrito que não faz nada
        // significa que a abstração está muito restrita
    }
}
</code></pre>
                    </section>
                    <section>
                        <pre><code class="language-php">class Retangulo {
    public function setAltura($altura) {
        $this->altura = $altura;
    }
    public function setLargura($largura) {
        $this->largura = $largura;
    }
}

class Quadrado extends Retangulo {
    public function setAltura($altura) {
        $this->altura = $altura;
        $this->largura = $altura;
    }
    public function setLargura($largura) {
        $this->altura = $largura;
        $this->largura = $largura;
    }
}
</code></pre>
                    </section>
                    <section>
                        <h4>Como resolver?</h4>
                        <p class="fragment">Herança não deve ser utilizada quando uma subclasse restringe a liberdade imposta na classe principal, mas sim quando adiciona mais detalhes</p>
                        <p class="fragment">Nesses casos, use composição.</p>
                    </section>

                    <!-- SOLID: Interface Segregation -->
                    <section>
                        <h3>Interface Segregation Principle</h3>
                        <p class="fragment">é preferível ter várias interfaces mais específicas do que uma genérica</p>
                    </section>
                    <section>
                        <pre><code class="language-php">interface ConfigInterface {
    public function get($property);
    public function set($property, $value);
}</code></pre>
                    </section>
                    <section>
                        <p>Mas toda configuração pode ser modificável?</p>
                        <pre><code class="language-php">interface ConfigInterface {
    public function get($property);
}

interface WritableConfigInterface {
    public function get($property);
    public function set($property, $value);
}</code></pre>
                    </section>
                    <section>
                        <h4>Como resolver?</h4>
                        <p class="fragment">Segrege suas interfaces ao invés de criar uma que atenda todos os casos</p>
                    </section>

                    <!-- SOLID: Dependency Inversion -->
                    <section>
                        <h3>Dependency Inversion Principle</h3>
                        <p class="fragment">dependa de abstrações <em>(interfaces)</em> ao invés de classes concretas</p>
                    </section>
                    <section>
                        <pre><code class="language-php">// PSR15 - https://www.php-fig.org/psr/psr-15/

namespace Interop\Http\Server;

use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;

interface RequestHandlerInterface {
    public function handle(
        ServerRequestInterface $request
    ): ResponseInterface;
}</code></pre>
                    </section>
                    <section>
                        <p>Isso facilita muito para fazer testes!</p>
                        <pre><code class="language-php">class UserRepository {
    public function __construct(Adapter $adapter) {
        /* ... */
    }

    public function create(User $user) {
        $this->adapter->insert('users', /* ... */);
    }
}</code></pre>
                    </section>
                    <section>
                        <pre><code class="language-php">class UserRepositoryTest {
    public function __construct() {
        $this->adapter = new Adapter();
        // É preciso sempre limpar a base antes de começar
        $this->adapter->delete('users');
    }

    public function run() {
        $repository = new UserRepository($this->adapter);
        $repository->save(new User());
    }
}</code></pre>
                    </section>
                    <section>
                        <pre><code class="language-php">class UserRepository {
    public function __construct(AdapterInterface $adapter) {
        /* ... */
    }

    public function create(User $user) {
        $this->adapter->insert('users', /* ... */);
    }
}</code></pre>
                    </section>
                    <section>
                        <pre><code class="language-php">interface AdapterInterface {
    public function insert($table, array $data);
}
class RealAdapter extends AdapterInterface {
    public function insert($table, array $data) {
        return $this->pdo->exec('INSERT ...');
    }
}
class TestsAdapter extends AdapterInterface {
    public function insert($table, array $data) {
        return true;
    }
}
</code></pre>
                    </section>
                </section>

                <section>
                    <h2>Object Calisthenics</h2>
                </section>

                <section>
                    <h2>PHPCS</h2>
                </section>

                <section>
                    <h2>PHPMD</h2>
                </section>

                <section>
                    <h2>Referências</h2>
                    <ul>
                        <li><a href="https://imasters.com.br/back-end/solid-com-php">imasters.com.br/back-end/solid-com-php</a></li>
                        <li><a href="http://www.eduardopires.net.br/2015/01/solid-teoria-e-pratica/">eduardopires.net.br</a></li>
                        <li><a href="https://hackernoon.com/solid-principles-530b2cc2badf">hackernoon.com</a></li>
                        <li><a href="https://www.netguru.co/codestories/solid-principles-1-single-responsibility-principle">netguru.co</a></li>
                        <li><a href="https://phpbestpractices.org/">phpbestpractices.org</a></li>
                        <li><a href="https://phptherightway.com/">phptherightway.com</a></li>
                    </ul>
                </section>
            </div>
        </div>

        <script src="reveal.js/lib/js/head.min.js"></script>
        <script src="reveal.js/js/reveal.js"></script>

        <script>
            Reveal.initialize({
                dependencies: [
                    { src: 'js/prism.js', async: true }
                ],
                slideNumber: true,
                mouseWheel: true,
                history: true,
                overview: false
            });
        </script>
    </body>
</html>
